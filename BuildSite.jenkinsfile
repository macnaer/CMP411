#!groovy

pipeline {
    agent any

    stages {
        stage("Create Site image") {
            steps {
                echo 'ğŸ§± Building Site image ...'
                sh "docker build --no-cache -t macnaer/site ."
            }
        }

        stage("Docker login") {
            steps {
                echo "ğŸ” Logging in to DockerHub ..."
                withCredentials([usernamePassword(credentialsId: 'DockerHub-Credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
                    sh '''
                        docker login -u $USERNAME -p $PASSWORD
                    '''
                }
            }
        }

        stage("Push Site to DockerHub") {
            steps {
                echo "ğŸš€ Pushing Site image to DockerHub ..."
                sh '''
                    docker push macnaer/site
                '''
            }
        }

        stage("Deploy Site on remote server") {
            agent { label 'agent1' }
            steps {
                echo "ğŸŒ Deploying Site container on remote server ..."
                sh '''
                    echo "ğŸ§¹ Cleaning up old Nagios container and image..."
                    docker stop stete || true
                    docker rm site || true
                    docker rmi macnaer/site || true

                    echo "â¬‡ï¸ Pulling latest Nagios image..."
                    docker pull macnaer/site

                    echo "ğŸš€ Starting new Nagios container..."
                    docker run -d --name site --restart=always -p 80:80  macnaer/site
                '''
            } 
        }
    }
}